<script>

// ================= AUTH CHECK =================
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

if(!currentUser || currentUser.role !== "distributor"){
  alert("Bạn không có quyền truy cập!");
  window.location.href = "login.html";
}

document.getElementById("userInfo").innerHTML =
  "Đăng nhập với: <b>" + currentUser.username + "</b>";

// ================= WEB3 INIT =================
let web3;
let contract;
let account;

const contractAddress = "0x8AF3c8aa5D9c63a40F4D9b6C7c30e2Fa3e5F8170";
const abi = [/* ABI của bạn */];

window.addEventListener("load", async () => {
  if(window.ethereum){
    try{
      web3 = new Web3(window.ethereum);
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      account = accounts[0];
      contract = new web3.eth.Contract(abi, contractAddress);
      console.log("Connected:", account);
    } catch(err){
      alert("Kết nối MetaMask thất bại!");
    }
  } else {
    alert("Vui lòng cài MetaMask!");
  }
});

// ================= HELPER =================
function showStatus(message, success=true){
  const box = document.getElementById("statusBox");
  box.style.display = "block";
  box.style.background = success ? "#d4edda" : "#f8d7da";
  box.style.color = success ? "#155724" : "#721c24";
  box.innerText = message;
}

// ================= FETCH TRANSFERS =================
async function fetchTransfers(){
  if(!contract) return showStatus("Chưa kết nối blockchain!", false);

  try{
    document.body.classList.add("loading");

    const events = await contract.getPastEvents('OwnershipTransferred', {
      fromBlock: 0,
      toBlock: 'latest'
    });

    const filtered = events.filter(e =>
      e.returnValues.newOwner.toLowerCase() === account.toLowerCase()
    );

    const tbody = document.querySelector("#transfersTable tbody");
    tbody.innerHTML = '';

    if(filtered.length === 0){
      showStatus("Không có giao dịch nào!", false);
      document.body.classList.remove("loading");
      return;
    }

    for(const event of filtered){
      const block = await web3.eth.getBlock(event.blockNumber);
      const timestamp = new Date(block.timestamp * 1000)
        .toLocaleString('vi-VN');

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${event.returnValues.id}</td>
        <td>${event.returnValues.previousOwner}</td>
        <td>${timestamp}</td>
        <td>
          <button class="confirm-btn"
            onclick="confirmTransfer(${event.returnValues.id})">
            Xác Nhận
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    }

    showStatus("Tải giao dịch thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= CONFIRM =================
async function confirmTransfer(id){
  if(!contract) return showStatus("Chưa kết nối blockchain!", false);

  try{
    document.body.classList.add("loading");

    await contract.methods
      .updateStatus(id, "Đã xác nhận nhận hàng")
      .send({ from: account });

    showStatus("Xác nhận thành công ID: " + id);

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= TRANSFER =================
async function transferToDistributor(){
  if(!contract) return showStatus("Chưa kết nối blockchain!", false);

  try{
    const id = parseInt(document.getElementById("distTransferId").value);
    const other = document.getElementById("distBuyerAddress").value;

    if(!id || !web3.utils.isAddress(other)){
      return showStatus("Thông tin không hợp lệ!", false);
    }

    document.body.classList.add("loading");

    await contract.methods
      .transferOwnership(id, other)
      .send({ from: account });

    showStatus("Chuyển giao thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= UPDATE STATUS =================
async function updateStatus(){
  if(!contract) return showStatus("Chưa kết nối blockchain!", false);

  try{
    const id = parseInt(document.getElementById("updateId").value);
    const newStatusValue = document.getElementById("newStatus").value;

    if(!id || !newStatusValue){
      return showStatus("Vui lòng nhập đầy đủ!", false);
    }

    document.body.classList.add("loading");

    await contract.methods
      .updateStatus(id, newStatusValue)
      .send({ from: account });

    showStatus("Cập nhật trạng thái thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= LOGOUT =================
function logout(){
  localStorage.removeItem("currentUser");
  window.location.href = "login.html";
}

</script>
