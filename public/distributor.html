<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distributor - Blockchain Traceability</title>

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f0f8ff;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container{
  background:#fff;
  width:95%;
  max-width:600px;
  padding:40px;
  border-radius:15px;
  box-shadow:0 4px 20px rgba(0,119,182,0.2);
}

h1{
  text-align:center;
  color:#0077b6;
  margin-bottom:10px;
}

.user-info{
  text-align:center;
  margin-bottom:20px;
  font-size:14px;
  color:#555;
}

.section{
  margin-top:30px;
}

h2{
  color:#0077b6;
  font-size:18px;
  margin-bottom:10px;
}

input{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #00a8e8;
  font-size:14px;
}

button{
  width:100%;
  padding:12px;
  background:#0077b6;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-top:10px;
  font-size:15px;
  transition:0.3s;
}

button:hover{
  background:#005f8f;
}

.logout{
  background:#e63946;
}

.logout:hover{
  background:#c1121f;
}

.status-box{
  margin-top:15px;
  padding:10px;
  border-radius:6px;
  background:#e6f7ff;
  font-size:14px;
  display:none;
}

.loading{
  opacity:0.6;
  pointer-events:none;
}
</style>
</head>

<body>

<div class="container">

<h1>Nhà Phân Phối</h1>
<div class="user-info" id="userInfo"></div>

<div class="section">
  <h2>Xác Nhận Lô Hàng Nhập</h2>
  <input id="receiveId" placeholder="ID sản phẩm (từ nhà sản xuất)">
  <input id="receiveQuantity" placeholder="Số lượng nhận (ví dụ: 100)">
  <button onclick="receiveShipment()">Xác Nhận Nhận Hàng</button>
</div>

<div class="section">
  <h2>Cập Nhật Thông Tin Phân Phối</h2>
  <input id="distributeId" placeholder="ID sản phẩm">
  <input id="nextLocation" placeholder="Nơi phân phối tiếp theo (ví dụ: Cửa hàng ABC)">
  <input id="distributionLocation" placeholder="Địa điểm phân phối (ví dụ: TP.HCM)">
  <input id="distributeQuantity" placeholder="Số lượng phân phối (ví dụ: 50)">
  <button onclick="updateDistribution()">Cập Nhật Phân Phối</button>
</div>

<div class="section">
  <h2>Cập Nhật Trạng Thái</h2>
  <input id="updateId" placeholder="ID sản phẩm">
  <input id="newStatus" placeholder="Trạng thái mới (Đang vận chuyển, Đã giao...)">
  <button onclick="updateStatus()">Cập Nhật</button>
</div>

<div class="section">
  <h2>Chuyển Giao Quyền Sở Hữu</h2>
  <input id="transferId" placeholder="ID sản phẩm">
  <input id="buyerAddress" placeholder="Địa chỉ MetaMask người mua (0x...)">
  <button onclick="transferOwnership()">Chuyển Giao</button>
</div>

<div class="status-box" id="statusBox"></div>

<button class="logout" onclick="logout()">Đăng Xuất</button>

</div>

<script>

// ================= AUTH CHECK =================
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

if(!currentUser || currentUser.role !== "distributor"){
  alert("Bạn không có quyền truy cập!");
  window.location.href = "login.html";
}

document.getElementById("userInfo").innerHTML =
  "Đăng nhập với: <b>" + currentUser.username + "</b>";

// ================= WEB3 INIT =================
let web3;
let contract;
const contractAddress = "0xb4D1159D9A955D7004c0431f57Df7FB067a53d23";
const abi = [...]; // ⚠ Giữ nguyên ABI của bạn ở đây

window.addEventListener("load", async () => {
  if(window.ethereum){
    web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    contract = new web3.eth.Contract(abi, contractAddress);
  } else {
    alert("Vui lòng cài MetaMask!");
  }
});

// ================= HELPER =================
function showStatus(message, success=true){
  const box = document.getElementById("statusBox");
  box.style.display = "block";
  box.style.background = success ? "#d4edda" : "#f8d7da";
  box.style.color = success ? "#155724" : "#721c24";
  box.innerText = message;
}

// ================= RECEIVE SHIPMENT =================
async function receiveShipment(){
  try{
    const id = parseInt(receiveId.value);
    const quantity = receiveQuantity.value;

    if(!id || !quantity){
      showStatus("Vui lòng nhập đầy đủ thông tin!", false);
      return;
    }

    const timestamp = new Date().toLocaleString('vi-VN');
    const newStatus = `Đã nhận lô hàng từ nhà sản xuất lúc ${timestamp}, số lượng: ${quantity}`;

    document.body.classList.add("loading");

    const accounts = await web3.eth.getAccounts();

    await contract.methods
      .updateStatus(id, newStatus)
      .send({ from: accounts[0] });

    showStatus("Xác nhận nhận hàng thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= UPDATE DISTRIBUTION =================
async function updateDistribution(){
  try{
    const id = parseInt(distributeId.value);
    const nextLoc = nextLocation.value;
    const loc = distributionLocation.value;
    const quantity = distributeQuantity.value;

    if(!id || !nextLoc || !loc || !quantity){
      showStatus("Vui lòng nhập đầy đủ thông tin!", false);
      return;
    }

    const timestamp = new Date().toLocaleString('vi-VN');
    const newStatus = `Phân phối đến ${nextLoc} lúc ${timestamp}, địa điểm: ${loc}, số lượng: ${quantity}`;

    document.body.classList.add("loading");

    const accounts = await web3.eth.getAccounts();

    await contract.methods
      .updateStatus(id, newStatus)
      .send({ from: accounts[0] });

    showStatus("Cập nhật phân phối thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= UPDATE STATUS =================
async function updateStatus(){
  try{
    const id = parseInt(updateId.value);
    const newStatus = newStatus.value;

    if(!id || !newStatus){
      showStatus("Vui lòng nhập đầy đủ thông tin!", false);
      return;
    }

    document.body.classList.add("loading");

    const accounts = await web3.eth.getAccounts();

    await contract.methods
      .updateStatus(id, newStatus)
      .send({ from: accounts[0] });

    showStatus("Cập nhật trạng thái thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= TRANSFER =================
async function transferOwnership(){
  try{
    const id = parseInt(transferId.value);
    const buyer = buyerAddress.value;

    if(!web3.utils.isAddress(buyer)){
      showStatus("Địa chỉ ví không hợp lệ!", false);
      return;
    }

    document.body.classList.add("loading");

    const accounts = await web3.eth.getAccounts();

    await contract.methods
      .transferOwnership(id, buyer)
      .send({ from: accounts[0] });

    showStatus("Chuyển giao thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= LOGOUT =================
function logout(){
  localStorage.removeItem("currentUser");
  window.location.href = "login.html";
}

</script>

</body>
</html>
