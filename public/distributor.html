<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distributor - Blockchain Traceability</title>

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f0f8ff;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container{
  background:#fff;
  width:95%;
  max-width:650px;
  padding:40px;
  border-radius:15px;
  box-shadow:0 4px 20px rgba(0,119,182,0.2);
}

h1{
  text-align:center;
  color:#0077b6;
}

.user-info{
  text-align:center;
  margin:10px 0 30px;
  font-size:14px;
  color:#555;
}

.section{
  margin-top:30px;
}

h2{
  color:#0077b6;
  font-size:18px;
  margin-bottom:12px;
}

input{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #00a8e8;
  font-size:14px;
  box-sizing:border-box;
}

button{
  width:100%;
  padding:14px;
  background:#0077b6;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-top:10px;
  font-size:15px;
}

button:hover{
  background:#005f8f;
}

.logout{
  background:#e63946;
}

.logout:hover{
  background:#c1121f;
}

.status-box{
  margin-top:15px;
  padding:12px;
  border-radius:6px;
  background:#e6f7ff;
  font-size:14px;
  display:none;
}

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

.table th, .table td{
  border:1px solid #ddd;
  padding:8px;
  text-align:left;
}

.table th{
  background:#0077b6;
  color:white;
}

.confirm-btn{
  background:#28a745;
  padding:6px 12px;
  border:none;
  border-radius:4px;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="container">

<h1>Nhà Phân Phối</h1>
<div class="user-info" id="userInfo"></div>

<!-- ================= 1. XEM & XÁC NHẬN GIAO DỊCH TỪ MANUFACTURER ================= -->
<div class="section">
  <h2>1. Xem giao dịch chuyển giao từ Manufacturer</h2>
  <button onclick="fetchTransfers()">Tải danh sách giao dịch</button>
  
  <table class="table" id="transfersTable">
    <thead>
      <tr>
        <th>ID Sản phẩm</th>
        <th>Từ Address</th>
        <th>Thời gian</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ================= 2. CHUYỂN GIAO CHO DISTRIBUTOR KHÁC ================= -->
<div class="section">
  <h2>2. Chuyển giao quyền sở hữu cho Distributor khác</h2>
  <input id="distTransferId" placeholder="ID sản phẩm">
  <input id="distBuyerAddress" placeholder="Địa chỉ MetaMask distributor khác (0x...)">
  <button onclick="transferToDistributor()">Chuyển Giao</button>
</div>

<!-- ================= 3. CẬP NHẬT TRẠNG THÁI (giữ nguyên) ================= -->
<div class="section">
  <h2>Cập nhật trạng thái</h2>
  <input id="updateId" placeholder="ID sản phẩm">
  <input id="newStatus" placeholder="Trạng thái mới (Đang vận chuyển, Đã giao...)">
  <button onclick="updateStatus()">Cập Nhật Trạng Thái</button>
</div>

<div class="status-box" id="statusBox"></div>

<button class="logout" onclick="logout()">Đăng Xuất</button>

</div>

<script>
// ================= AUTH CHECK =================
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if(!currentUser || currentUser.role !== "distributor"){
  alert("Bạn không có quyền truy cập!");
  window.location.href = "login.html";
}
document.getElementById("userInfo").innerHTML = "Đăng nhập với: <b>" + currentUser.username + "</b>";

// ================= WEB3 INIT =================
let web3;
let contract;
let account;
const contractAddress = "0x8AF3c8aa5D9c63a40F4D9b6C7c30e2Fa3e5F8170";
const abi = [ /* Paste nguyên ABI của bạn vào đây (giữ nguyên như trước) */ ];

window.addEventListener("load", async () => {
  if(window.ethereum){
    web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const accounts = await web3.eth.getAccounts();
    account = accounts[0];
    contract = new web3.eth.Contract(abi, contractAddress);
  } else {
    alert("Vui lòng cài MetaMask!");
  }
});

// ================= HELPER =================
function showStatus(message, success = true){
  const box = document.getElementById("statusBox");
  box.style.display = "block";
  box.style.background = success ? "#d4edda" : "#f8d7da";
  box.style.color = success ? "#155724" : "#721c24";
  box.innerText = message;
}

// ================= 1. XEM & XÁC NHẬN GIAO DỊCH TỪ MANUFACTURER =================
async function fetchTransfers(){
  try{
    document.body.classList.add("loading");
    const events = await contract.getPastEvents('OwnershipTransferred', {
      fromBlock: 0,
      toBlock: 'latest'
    });

    const filtered = events.filter(e => e.returnValues.newOwner.toLowerCase() === account.toLowerCase());

    const tbody = document.querySelector("#transfersTable tbody");
    tbody.innerHTML = "";

    if(filtered.length === 0){
      showStatus("Chưa có giao dịch chuyển giao nào cho bạn", false);
      return;
    }

    for(const event of filtered){
      const block = await web3.eth.getBlock(event.blockNumber);
      const time = new Date(block.timestamp * 1000).toLocaleString('vi-VN');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${event.returnValues.id}</td>
        <td>${event.returnValues.newOwner}</td>
        <td>${time}</td>
        <td><button class="confirm-btn" onclick="confirmTransfer(${event.returnValues.id})">Xác Nhận</button></td>
      `;
      tbody.appendChild(tr);
    }
    showStatus("Đã tải " + filtered.length + " giao dịch");
  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }
  document.body.classList.remove("loading");
}

async function confirmTransfer(id){
  try{
    document.body.classList.add("loading");
    const accounts = await web3.eth.getAccounts();
    await contract.methods.updateStatus(id, "Đã xác nhận nhận hàng từ Manufacturer").send({from: accounts[0]});
    showStatus("Xác nhận thành công cho ID " + id);
    fetchTransfers(); // refresh lại danh sách
  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }
  document.body.classList.remove("loading");
}

// ================= 2. CHUYỂN GIAO CHO DISTRIBUTOR KHÁC =================
async function transferToDistributor(){
  try{
    const id = parseInt(document.getElementById("distTransferId").value);
    const buyer = document.getElementById("distBuyerAddress").value.trim();

    if(!id || !web3.utils.isAddress(buyer)){
      showStatus("ID hoặc địa chỉ không hợp lệ!", false);
      return;
    }

    document.body.classList.add("loading");
    const accounts = await web3.eth.getAccounts();
    await contract.methods.transferOwnership(id, buyer).send({from: accounts[0]});
    showStatus("Chuyển giao thành công cho distributor khác!");
  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }
  document.body.classList.remove("loading");
}

// ================= CẬP NHẬT TRẠNG THÁI (giữ nguyên) =================
async function updateStatus(){
  try{
    const id = parseInt(document.getElementById("updateId").value);
    const newStatus = document.getElementById("newStatus").value.trim();

    if(!id || !newStatus){
      showStatus("Vui lòng nhập đầy đủ thông tin!", false);
      return;
    }

    document.body.classList.add("loading");
    const accounts = await web3.eth.getAccounts();
    await contract.methods.updateStatus(id, newStatus).send({from: accounts[0]});
    showStatus("Cập nhật trạng thái thành công!");
  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }
  document.body.classList.remove("loading");
}

// ================= LOGOUT =================
function logout(){
  localStorage.removeItem("currentUser");
  window.location.href = "login.html";
}

</script>
</body>
</html>
