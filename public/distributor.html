<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Distributor - Blockchain Traceability</title>

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f0f8ff;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container{
  background:#fff;
  width:95%;
  max-width:600px;
  padding:40px;
  border-radius:15px;
  box-shadow:0 4px 20px rgba(0,119,182,0.2);
}

h1{
  text-align:center;
  color:#0077b6;
  margin-bottom:10px;
}

.user-info{
  text-align:center;
  margin-bottom:20px;
  font-size:14px;
  color:#555;
}

.section{
  margin-top:30px;
}

h2{
  color:#0077b6;
  font-size:18px;
  margin-bottom:10px;
}

input{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #00a8e8;
  font-size:14px;
}

button{
  width:100%;
  padding:12px;
  background:#0077b6;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-top:10px;
  font-size:15px;
  transition:0.3s;
}

button:hover{
  background:#005f8f;
}

.logout{
  background:#e63946;
}

.logout:hover{
  background:#c1121f;
}

.status-box{
  margin-top:15px;
  padding:10px;
  border-radius:6px;
  background:#e6f7ff;
  font-size:14px;
  display:none;
}

.loading{
  opacity:0.6;
  pointer-events:none;
}

.table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}

.table th, .table td{
  border:1px solid #ddd;
  padding:8px;
  text-align:left;
}

.table th{
  background:#0077b6;
  color:white;
}

.confirm-btn{
  background:#28a745;
  color:white;
  border:none;
  padding:5px 10px;
  border-radius:4px;
  cursor:pointer;
  width:auto;
}

.confirm-btn:hover{
  background:#218838;
}
</style>
</head>

<body>

<div class="container">

<h1>Nhà Phân Phối</h1>
<div class="user-info" id="userInfo"></div>

<div class="section">
  <h2>1. Xem Và Xác Nhận Giao Dịch Chuyển Giao Từ Manufacturer</h2>
  <button onclick="fetchTransfers()">Tải Danh Sách Giao Dịch</button>
  <table class="table" id="transfersTable">
    <thead>
      <tr>
        <th>ID Sản Phẩm</th>
        <th>Từ Address</th>
        <th>Timestamp</th>
        <th>Hành Động</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <h2>2. Chuyển Giao Quyền Sở Hữu Cho Distributor Khác</h2>
  <input id="distTransferId" placeholder="ID sản phẩm">
  <input id="distBuyerAddress" placeholder="Địa chỉ MetaMask distributor khác (0x...)">
  <button onclick="transferToDistributor()">Chuyển Giao</button>
</div>

<div class="section">
  <h2>Cập Nhật Trạng Thái</h2>
  <input id="updateId" placeholder="ID sản phẩm">
  <input id="newStatus" placeholder="Trạng thái mới (Đang vận chuyển, Đã giao...)">
  <button onclick="updateStatus()">Cập Nhật</button>
</div>

<div class="status-box" id="statusBox"></div>

<button class="logout" onclick="logout()">Đăng Xuất</button>

</div>

<script>

// ================= AUTH CHECK =================
const currentUser = JSON.parse(localStorage.getItem("currentUser"));

if(!currentUser || currentUser.role !== "distributor"){
  alert("Bạn không có quyền truy cập!");
  window.location.href = "login.html";
}

document.getElementById("userInfo").innerHTML =
  "Đăng nhập với: <b>" + currentUser.username + "</b>";

// ================= WEB3 INIT =================
let web3;
let contract;
let account;
const contractAddress = "0x8AF3c8aa5D9c63a40F4D9b6C7c30e2Fa3e5F8170"; // Address mới nhất
const abi = [/* Paste ABI đầy đủ của bạn ở đây, giống trước */]; // Giữ nguyên ABI

window.addEventListener("load", async () => {
  if(window.ethereum){
    web3 = new Web3(window.ethereum);
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    account = accounts[0];
    contract = new web3.eth.Contract(abi, contractAddress);
    console.log("Connected account:", account);
  } else {
    alert("Vui lòng cài MetaMask!");
  }
});

// ================= HELPER =================
function showStatus(message, success=true){
  const box = document.getElementById("statusBox");
  box.style.display = "block";
  box.style.background = success ? "#d4edda" : "#f8d7da";
  box.style.color = success ? "#155724" : "#721c24";
  box.innerText = message;
}

// ================= FETCH TRANSFERS (Chức Năng 1: Xem Giao Dịch) =================
async function fetchTransfers(){
  try{
    document.body.classList.add("loading");

    // Fetch all OwnershipTransferred events
    const events = await contract.getPastEvents('OwnershipTransferred', {
      fromBlock: 0,
      toBlock: 'latest'
    });

    // Lọc event nơi newOwner là address distributor hiện tại
    const filteredEvents = events.filter(event => event.returnValues.newOwner.toLowerCase() === account.toLowerCase());

    // Hiển thị trong table
    const tbody = document.querySelector("#transfersTable tbody");
    tbody.innerHTML = ''; // Clear old data

    if(filteredEvents.length === 0){
      showStatus("Không có giao dịch chuyển giao nào!", false);
      return;
    }

    for(const event of filteredEvents){
      const tr = document.createElement('tr');
      const block = await web3.eth.getBlock(event.blockNumber);
      const timestamp = new Date(block.timestamp * 1000).toLocaleString('vi-VN');

      tr.innerHTML = `
        <td>${event.returnValues.id}</td>
        <td>${event.returnValues.newOwner}</td> <!-- From address is previous owner, but event has newOwner -->
        <td>${timestamp}</td>
        <td><button class="confirm-btn" onclick="confirmTransfer(${event.returnValues.id})">Xác Nhận</button></td>
      `;
      tbody.appendChild(tr);
    }

    showStatus("Danh sách giao dịch đã tải thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= CONFIRM TRANSFER (Xác Nhận Giao Dịch) =================
async function confirmTransfer(id){
  try{
    document.body.classList.add("loading");

    const accounts = await web3.eth.getAccounts();
    const confirmStatus = "Đã xác nhận nhận hàng từ manufacturer";

    await contract.methods
      .updateStatus(id, confirmStatus)
      .send({ from: accounts[0] });

    showStatus("Xác nhận giao dịch thành công cho ID " + id);

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= TRANSFER TO OTHER DISTRIBUTOR (Chức Năng 2) =================
async function transferToDistributor(){
  try{
    const id = parseInt(distTransferId.value);
    const otherDistAddress = distBuyerAddress.value;

    if(!id || !web3.utils.isAddress(otherDistAddress)){
      showStatus("Thông tin không hợp lệ!", false);
      return;
    }

    document.body.classList.add("loading");

    const accounts = await web3.eth.getAccounts();

    await contract.methods
      .transferOwnership(id, otherDistAddress)
      .send({ from: accounts[0] });

    showStatus("Chuyển giao cho distributor khác thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= UPDATE STATUS (Giữ Nguyên) =================
async function updateStatus(){
  try{
    const id = parseInt(updateId.value);
    const newStatus = newStatus.value;

    if(!id || !newStatus){
      showStatus("Vui lòng nhập đầy đủ thông tin!", false);
      return;
    }

    document.body.classList.add("loading");

    const accounts = await web3.eth.getAccounts();

    await contract.methods
      .updateStatus(id, newStatus)
      .send({ from: accounts[0] });

    showStatus("Cập nhật trạng thái thành công!");

  } catch(err){
    showStatus("Lỗi: " + err.message, false);
  }

  document.body.classList.remove("loading");
}

// ================= LOGOUT =================
function logout(){
  localStorage.removeItem("currentUser");
  window.location.href = "login.html";
}

</script>

</body>
</html>
