<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xác Thực Sản Phẩm - Blockchain Traceability</title>

  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f4f8;
      color: #2d3436;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      background-color: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 119, 182, 0.15);
      padding: 35px;
      max-width: 550px;
      width: 90%;
      border-top: 8px solid #0077b6;
    }

    h1 {
      text-align: center;
      color: #0077b6;
      margin-bottom: 25px;
      font-size: 26px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #result {
      background-color: #f8fbff;
      border: 1px solid #d1e3f8;
      border-radius: 12px;
      padding: 20px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #edf2f7;
    }

    .info-row:last-child { border-bottom: none; }

    .label { font-weight: 600; color: #636e72; }
    .value { font-weight: 500; color: #2d3436; text-align: right; }

    .status-valid {
      color: #27ae60;
      font-weight: bold;
      background: #e8f8f0;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .status-invalid {
      color: #e74c3c;
      font-weight: bold;
      background: #fdf2f0;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .history-box {
      margin-top: 15px;
      padding: 15px;
      background: #f1f2f6;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
    }

    .address-text {
      font-family: monospace;
      font-size: 12px;
      color: #0077b6;
      word-break: break-all;
    }

    .loading { text-align: center; color: #0077b6; font-style: italic; }
    .error { color: #d63031; text-align: center; font-weight: bold; }
  </style>
</head>

<body>

  <div class="container">
    <h1>Thông Tin Sản Phẩm</h1>
    <div id="result" class="loading">Đang kết nối ví và tải dữ liệu...</div>
  </div>

<script>
  /* ========================================================
     1. CẤU HÌNH SMART CONTRACT
     ======================================================== */
  const contractAddress = "0x8AF3c8aa5D9c63a40F4D9b6C7c30e2Fa3e5F8170"; // Địa chỉ bạn đã cung cấp
  const abi = [
    { "inputs": [{ "internalType": "uint256", "name": "_id", "type": "uint256" }], "name": "verifyProduct", "outputs": [{ "internalType": "string", "name": "name", "type": "string" }, { "internalType": "string", "name": "batchID", "type": "string" }, { "internalType": "uint256", "name": "manufactureDate", "type": "uint256" }, { "internalType": "string", "name": "origin", "type": "string" }, { "internalType": "bool", "name": "isAuthentic", "type": "bool" }, { "internalType": "string[]", "name": "history", "type": "string[]" }, { "internalType": "address", "name": "owner", "type": "address" }], "stateMutability": "view", "type": "function" }
  ];

  let web3;
  let contract;

  window.addEventListener("load", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    if (!id) {
      document.getElementById("result").innerHTML = "<p class='error'>Lỗi: Không tìm thấy ID sản phẩm trên URL!</p>";
      return;
    }

    /* ========================================================
       2. KẾT NỐI METAMASK
       ======================================================== */
    if (window.ethereum) {
      try {
        web3 = new Web3(window.ethereum);
        // Yêu cầu người dùng kết nối ví
        await window.ethereum.request({ method: "eth_requestAccounts" });
        contract = new web3.eth.Contract(abi, contractAddress);
        
        loadProductData(Number(id));
      } catch (err) {
        document.getElementById("result").innerHTML = "<p class='error'>Bạn cần từ chối hoặc kết nối ví để tiếp tục!</p>";
      }
    } else {
      document.getElementById("result").innerHTML = "<p class='error'>Vui lòng cài đặt MetaMask để sử dụng chức năng này!</p>";
    }
  });

  /* ========================================================
     3. TRUY XUẤT VÀ HIỂN THỊ DỮ LIỆU
     ======================================================== */
  async function loadProductData(productId) {
    try {
      const res = await contract.methods.verifyProduct(productId).call();

      // Định dạng ngày tháng
      const date = new Date(Number(res[2]) * 1000).toLocaleDateString('vi-VN', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      // Tạo HTML hiển thị
      let html = `
        <div class="info-row">
          <span class="label">Tên sản phẩm:</span>
          <span class="value">${res[0]}</span>
        </div>
        <div class="info-row">
          <span class="label">Mã số lô:</span>
          <span class="value">${res[1]}</span>
        </div>
        <div class="info-row">
          <span class="label">Ngày sản xuất:</span>
          <span class="value">${date}</span>
        </div>
        <div class="info-row">
          <span class="label">Nguồn gốc:</span>
          <span class="value">${res[3]}</span>
        </div>
        <div class="info-row">
          <span class="label">Trạng thái:</span>
          <span class="${res[4] ? 'status-valid' : 'status-invalid'}">
            ${res[4] ? '✓ Chính hãng' : '⚠ Cảnh báo giả'}
          </span>
        </div>
        
        <div style="margin-top: 20px; font-weight: 600; color: #0077b6;">Lịch sử dịch chuyển:</div>
        <div class="history-box">
          ${res[5].length > 0 ? res[5].map(step => `• ${step}`).join('<br>') : 'Chưa có dữ liệu lịch sử'}
        </div>

        <div style="margin-top: 15px;">
          <span class="label">Địa chỉ sở hữu hiện tại:</span><br>
          <span class="address-text">${res[6]}</span>
        </div>
      `;

      document.getElementById("result").innerHTML = html;

    } catch (err) {
      console.error(err);
      document.getElementById("result").innerHTML = "<p class='error'>Lỗi: Không thể truy xuất ID " + productId + " từ Blockchain.</p>";
    }
  }
</script>
</body>
</html>
