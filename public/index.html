<!DOCTYPE html>
<html>
<head>
  <title>Truy Xuất Mỹ Phẩm Blockchain</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
</head>
<body>
  <h1>Hệ Thống Truy Xuất Nguồn Gốc Mỹ Phẩm</h1>
  <h2>Tạo Sản Phẩm (Nhà Sản Xuất)</h2>
  <input id="name" placeholder="Tên sản phẩm"><br>
  <input id="batchID" placeholder="Mã lô"><br>
  <input id="manufactureDate" placeholder="Ngày sản xuất (timestamp)"><br>
  <input id="origin" placeholder="Nguồn gốc"><br>
  <button onclick="createProduct()">Tạo</button>
  <canvas id="qrCode"></canvas>
  <h2>Cập Nhật Trạng Thái (Nhà Phân Phối)</h2>
  <input id="updateId" placeholder="ID sản phẩm"><br>
  <input id="newStatus" placeholder="Trạng thái mới"><br>
  <button onclick="updateStatus()">Cập Nhật</button>
  <h2>Xác Thực Sản Phẩm (Người Tiêu Dùng)</h2>
  <input id="verifyId" placeholder="ID sản phẩm (từ QR)"><br>
  <button onclick="verifyProduct()">Xác Thực</button>
  <div id="result"></div>
  <script>
    const contractAddress = '0xbEe54C7334322A6BE9d02700854f7BB190fFB0ee'; // Address mới từ deploy
    const abi = [
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "name",
        "type": "string"
      }
    ],
    "name": "ProductCreated",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "id",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "newStatus",
        "type": "string"
      }
    ],
    "name": "StatusUpdated",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "productCount",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "products",
    "outputs": [
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "batchID",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "manufactureDate",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "origin",
        "type": "string"
      },
      {
        "internalType": "bool",
        "name": "isAuthentic",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  },
  {
    "inputs": [
      {
        "internalType": "string",
        "name": "_name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "_batchID",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "_manufactureDate",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "_origin",
        "type": "string"
      }
    ],
    "name": "createProduct",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "_newStatus",
        "type": "string"
      }
    ],
    "name": "updateStatus",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "_id",
        "type": "uint256"
      }
    ],
    "name": "verifyProduct",
    "outputs": [
      {
        "internalType": "string",
        "name": "name",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "batchID",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "manufactureDate",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "origin",
        "type": "string"
      },
      {
        "internalType": "bool",
        "name": "isAuthentic",
        "type": "bool"
      },
      {
        "internalType": "string[]",
        "name": "history",
        "type": "string[]"
      }
    ],
    "stateMutability": "view",
    "type": "function",
    "constant": true
  }
];
    const web3 = new Web3('http://127.0.0.1:7545');
    const contract = new web3.eth.Contract(abi, contractAddress);
    async function createProduct() {
      const accounts = await web3.eth.getAccounts();
      const name = document.getElementById('name').value;
      const batchID = document.getElementById('batchID').value;
      const manufactureDate = parseInt(document.getElementById('manufactureDate').value);
      const origin = document.getElementById('origin').value;
      await contract.methods.createProduct(name, batchID, manufactureDate, origin).send({from: accounts[0]});
      const id = await contract.methods.productCount().call();
      alert('Sản phẩm tạo thành công với ID: ' + id);
      QRCode.toCanvas(document.getElementById('qrCode'), id.toString(), function (error) {
        if (error) console.error(error);
      });
    }
    async function updateStatus() {
      const accounts = await web3.eth.getAccounts();
      const id = parseInt(document.getElementById('updateId').value);
      const newStatus = document.getElementById('newStatus').value;
      await contract.methods.updateStatus(id, newStatus).send({from: accounts[0]});
      alert('Cập nhật thành công');
    }
    async function verifyProduct() {
      const id = parseInt(document.getElementById('verifyId').value);
      const result = await contract.methods.verifyProduct(id).call();
      document.getElementById('result').innerHTML = `
        Tên: ${result[0]}<br>
        Mã lô: ${result[1]}<br>
        Ngày sản xuất: ${result[2]}<br>
        Nguồn gốc: ${result[3]}<br>
        Chính hãng: ${result[4] ? 'Có' : 'Không'}<br>
        Lịch sử: ${result[5].join('<br>')}
      `;
    }
  </script>
</body>
</html>